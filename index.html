<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نبراس النجاح</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #f1f5f9; /* slate-100 */
            --card-bg: #ffffff;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --border-color: #e5e7eb; /* gray-200 */
            --glass-bg: rgba(255, 255, 255, 0.6);
        }

        /* Dark theme styles */
        html.dark {
            --bg-primary: #020617; /* slate-950 */
            --bg-secondary: #0f172a; /* slate-900 */
            --card-bg: #1e293b; /* slate-800 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --glass-bg: rgba(30, 41, 59, 0.6); /* slate-800 with opacity */
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Component specific theming */
        .themed-bg-primary { background-color: var(--bg-primary); }
        .themed-bg-secondary { background-color: var(--bg-secondary); }
        .themed-card-bg { background-color: var(--card-bg); }
        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-border { border-color: var(--border-color); }
        
        .page { display: none; }
        .page.active { display: block; }

        .glassmorphism {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
        }

        html.dark .nav-item.active {
            color: #818cf8; /* indigo-400 */
            background-color: rgba(129, 140, 248, 0.1);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .toast {
            animation: slideInUpToast 0.5s ease-out forwards, fadeOutToast 0.5s ease-in 3.5s forwards;
        }
        @keyframes slideInUpToast { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: translateY(20px); height: 0; padding: 0; margin: 0; } }
        .auth-bg { background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); }
        .nav-item.active {
            color: #6366f1; /* violet-600 */
            background-color: rgba(99, 102, 241, 0.1);
        }
       
        .prose-rtl { direction: rtl; }
        .prose-rtl h1, .prose-rtl h2, .prose-rtl h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .prose-rtl ul { padding-right: 1.5rem; }
        .prose-rtl ol { padding-right: 1.5rem; }
        html.dark .prose-rtl blockquote { border-right: 4px solid #4b5563; }
        .prose-rtl blockquote { border-right: 4px solid #d1d5db; padding-right: 1rem; color: var(--text-secondary); }
        .prose-rtl code { background-color: var(--bg-secondary); padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
    </style>
</head>
<body>

    <!-- ===== Toast Container ===== -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <div id="app-container" class="min-h-screen flex flex-col max-w-7xl mx-auto themed-bg-primary">

        <!-- ===== Auth Screen ===== -->
        <div id="auth-screen" class="page flex-grow auth-bg">
             <div class="flex flex-col items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-md">
                    <div id="login-card" class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-gray-200/50">
                      <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">مرحباً بك مجدداً</h2>
                       <p class="text-center text-gray-500 mb-8">سجل دخولك لتكمل رحلة النجاح</p>
                      <form id="login-form" class="space-y-5">
                        <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg" required />
                        <input type="password" id="login-password" placeholder="كلمة المرور" class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg" required />
                        <button type="submit" id="login-button" class="w-full px-6 py-3 bg-violet-600 text-white font-semibold rounded-lg shadow-lg hover:bg-violet-700 transition duration-300 flex items-center justify-center">
                          <span class="button-text">تسجيل الدخول</span>
                          <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-violet-300 rounded-full h-6 w-6"></span>
                        </button>
                      </form>
                      <p class="mt-6 text-center text-gray-700">
                        ليس لديك حساب؟ <button id="show-register-btn" class="text-violet-600 font-semibold hover:underline">أنشئ حساباً جديداً</button>
                      </p>
                    </div>

                    <div id="register-card" class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-gray-200/50 hidden">
                      <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">انضم إلى نبراس النجاح</h2>
                      <p class="text-center text-gray-500 mb-8">خطوتك الأولى نحو التفوق</p>
                      <form id="register-form" class="space-y-5">
                        <input type="text" id="register-username" placeholder="الاسم الظاهر للناس" class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg" required />
                        <input type="email" id="register-email" placeholder="البريد الإلكتروني" class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg" required />
                        <input type="password" id="register-password" placeholder="كلمة المرور (6 أحرف على الأقل)" class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg" required />
                        <select id="register-stage" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg bg-white" required>
                                <option value="" disabled selected>اختر المرحلة الدراسية</option>
                                <option value="سادس ابتدائي">سادس ابتدائي</option>
                                <option value="ثالث متوسط">ثالث متوسط</option>
                                <option value="سادس اعدادي علمي">سادس اعدادي علمي</option>
                                <option value="سادس اعدادي ادبي">سادس اعدادي ادبي</option>
                        </select>
                        <button type="submit" id="register-button" class="w-full px-6 py-3 bg-violet-600 text-white font-semibold rounded-lg shadow-lg hover:bg-violet-700 transition duration-300 flex items-center justify-center">
                          <span class="button-text">إنشاء حساب</span>
                          <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-violet-300 rounded-full h-6 w-6"></span>
                        </button>
                      </form>
                      <p class="mt-6 text-center text-gray-700">
                        لديك حساب بالفعل؟ <button id="show-login-btn" class="text-violet-600 font-semibold hover:underline">تسجيل الدخول</button>
                      </p>
                    </div>
                </div>
              </div>
        </div>

        <!-- ===== Main App Content ===== -->
        <div id="main-app" class="page min-h-screen flex-col">
            <!-- Header -->
            <header class="glassmorphism p-4 flex items-center justify-between sticky top-4 mx-4 rounded-2xl z-40">
                <div class="flex items-center space-x-2">
                    <button id="theme-toggle-button" class="p-2 rounded-full themed-text-secondary hover:bg-black/10 dark:hover:bg-white/10 transition-colors">
                        <!-- Icon will be inserted by JS -->
                    </button>
                </div>
                <h1 class="text-2xl font-bold themed-text-primary tracking-wide">
                    نبراس النجاح
                </h1>
                <div class="flex items-center">
                    <div id="user-points-container" class="flex items-center text-violet-700 font-semibold text-lg bg-violet-100/50 dark:bg-violet-500/10 dark:text-violet-300 px-3 py-1.5 rounded-lg">
                        <span id="user-points-icon" class="w-6 h-6 ml-2 text-amber-500"></span>
                        <span id="user-points">0 نقطة</span>
                    </div>
                     <button id="profile-nav-button" class="p-2 rounded-full themed-text-secondary hover:bg-black/10 dark:hover:bg-white/10 transition-colors mr-2">
                        <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto">
                <!-- Pages will be dynamically rendered here -->
            </main>

            <!-- Navigation Bar (Footer) -->
            <nav id="nav-bar" class="glassmorphism p-2 flex justify-around items-center sticky bottom-4 z-40 rounded-full w-11/12 max-w-lg mx-auto">
                <!-- Nav items will be dynamically rendered here -->
            </nav>
        </div>
    </div>
    
    <!-- App Footer -->
    <footer class="text-center py-6 bg-transparent themed-text-secondary">
        <p class="font-semibold">© 2024 - تم التطوير بواسطة Mostafa Thabit</p>
        <div class="flex justify-center items-center space-x-4 mt-2">
            <a href="https://www.instagram.com/3_m.5_" target="_blank" class="themed-text-secondary hover:text-pink-500 dark:hover:text-pink-400 transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.626c-3.149 0-3.483.01-4.696.065-2.61.12-3.876 1.39-4.004 4.004-.055 1.21-.066 1.534-.066 4.696s.011 3.486.066 4.696c.128 2.61 1.394 3.876 4.004 4.004 1.213.054 1.547.066 4.696.066s3.482-.012 4.696-.066c2.61-.128 3.876-1.394 4.004-4.004.054-1.21.066-1.534.066-4.696s-.012-3.486-.066-4.696c-.128-2.61-1.394-3.876-4.004-4.004C15.482 3.799 15.15 3.789 12 3.789zm0 4.664c2.404 0 4.364 1.96 4.364 4.364s-1.96 4.364-4.364 4.364-4.364-1.96-4.364-4.364 1.96-4.364 4.364-4.364zm0 1.626c-1.512 0-2.738 1.226-2.738 2.738s1.226 2.738 2.738 2.738 2.738-1.226 2.738-2.738-1.226-2.738-2.738-2.738zm4.64-4.792c-.722 0-1.306.584-1.306 1.306s.584 1.306 1.306 1.306 1.306-.584 1.306-1.306-.584-1.306-1.306-1.306z"></path></svg>
            </a>
            <a href="https://t.me/xortil" target="_blank" class="themed-text-secondary hover:text-blue-500 dark:hover:text-blue-400 transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-1.088-1.01-1.05-1.58-1.59-2.582-2.394-.99-.792-.352-1.233.228-1.98.14-.183 2.62-2.38 2.62-2.566 0-.186-.114-.267-.29-.153l-3.237 2.035c-.62.39-1.132.588-1.84.39-1.04-.28-1.78-.778-2.38-1.26-1.02-1.02-1.38-1.38-1.44-1.44-.06-.06-1.44-1.38-1.02-2.4.42-1.02 2.52-3.06 2.64-3.18.12-.12 2.4-1.56 3.6-1.92.54-.156 1.02-.12 1.38-.06.06.06 1.02.48 1.38.78.36.3.66.6.9.84.24.24.42.42.54.54z"></path></svg>
            </a>
        </div>
    </footer>

    <!-- ===== Custom Modal ===== -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="themed-card-bg rounded-2xl shadow-xl w-full max-w-lg flex flex-col">
            <div id="modal-content" class="themed-text-primary text-lg text-center p-6 max-h-[70vh] overflow-y-auto">
                <!-- Modal content goes here -->
            </div>
            <div id="modal-loader" class="hidden animate-spin self-center my-8 border-4 border-gray-300 border-t-blue-500 rounded-full h-10 w-10"></div>
            <div class="p-4 themed-bg-secondary border-t themed-border text-center">
                 <button id="modal-close-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                    حسناً
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIG & GLOBAL VARIABLES
        // =================================================================

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = {
             apiKey: "AIzaSyDw6RHZx5N8EV150ly4OgSE-0giQx31RcY", // This key is public and safe to use.
             authDomain: "anit-35b28.firebaseapp.com",
             projectId: "anit-35b28",
             storageBucket: "anit-35b28.appspot.com",
             messagingSenderId: "246624432329",
             appId: "1:246624432329:web:963d7f7be41ec28f299d18"
        };
        
        const geminiApiKey = ""; // This will be handled by the execution environment.

        let db, auth;
        let userId = null;
        let userData = null;
        let isAuthReady = false;
        let isLoggedIn = false;
        let currentPage = 'home';
        let currentTheme = 'light';
        let communityQuestions = [];
        let leaderboardUsers = [];
        let reviews = [];
        let questionBank = [];

        let mainAppEl, authScreenEl, mainContentEl, navBarEl, userPointsEl, themeToggleButtonEl;
        let modalEl, modalContentEl, modalLoaderEl, modalCloseBtn;
        let loginFormEl, registerFormEl, loginCardEl, registerCardEl;
        
        // =================================================================
        // ICONS (SVG)
        // =================================================================
        const icons = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            book: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>`,
            brain: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.993.152M12 5a3 3 0 1 1 5.993.152M12 5a3 3 0 1 0-5.26 2.053M12 5a3 3 0 1 1 5.26 2.053M12 5a3 3 0 1 1-2.923 3.65C6.39 9.69 4 11.029 4 14.5a3.5 3.5 0 0 0 7 0v-1.5a.5.5 0 0 1 .5-.5.5.5 0 0 1 .5.5V14a2.5 2.5 0 0 1 5 0 3.5 3.5 0 0 0 7 0c0-3.471-2.39-4.81-5.077-5.85A3 3 0 0 1 12 5Z"/><path d="M4.5 14.5A3.5 3.5 0 0 1 8 11c0-1.07-.36-2.13-.78-3.04"/><path d="M19.5 14.5A3.5 3.5 0 0 0 16 11c0-1.07.36-2.13.78-3.04"/></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            lightbulb: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7c0-2.2-1.8-4-4-4S10 4.8 10 7c0 2 .3 3.2 1.5 4.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
            checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            logOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
            star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            reviews: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>`,
            gemini: `✨`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        };

        // =================================================================
        // RENDER FUNCTIONS
        // =================================================================

        function render() {
            if (!isAuthReady) {
                mainContentEl.innerHTML = `<div class="flex items-center justify-center h-full"><div class="animate-spin border-8 border-gray-300 border-t-indigo-500 rounded-full h-16 w-16"></div></div>`;
                return;
            }

            if (!isLoggedIn) {
                authScreenEl.style.display = 'flex';
                mainAppEl.style.display = 'none';
                authScreenEl.classList.add('active');
                mainAppEl.classList.remove('active');
            } else {
                authScreenEl.style.display = 'none';
                mainAppEl.style.display = 'flex';
                authScreenEl.classList.remove('active');
                mainAppEl.classList.add('active');
                document.getElementById('user-points').textContent = `${userData?.points || 0} نقطة`;
                document.getElementById('user-points-icon').innerHTML = icons.star;
                renderPage();
                renderNavBar();
            }
        }

        function renderPage() {
            mainContentEl.innerHTML = ''; 
            let content = '';
            switch (currentPage) {
                case 'home': content = getHomePageHTML(); break;
                case 'questionBank': content = getQuestionBankPageHTML(); break;
                case 'community': content = getCommunityPageHTML(); break;
                case 'leaderboard': content = getLeaderboardPageHTML(); break;
                case 'explanations': content = getExplanationsPageHTML(); break;
                case 'reviews': content = getReviewsPageHTML(); break;
                case 'profile': content = getProfilePageHTML(); break;
                default: content = getHomePageHTML();
            }
            mainContentEl.innerHTML = content;
            mainContentEl.scrollTop = 0;

            switch (currentPage) {
                case 'home': addHomeEventListeners(); break;
                case 'questionBank': addQuestionBankEventListeners(); break;
                case 'community': addCommunityEventListeners(); break;
                case 'explanations': addExplanationsEventListeners(); break;
                case 'reviews': addReviewsEventListeners(); break;
                case 'profile': addProfileEventListeners(); break;
            }
        }
        
        function renderNavBar() {
            const navItems = [
                { id: 'home', label: 'الرئيسية', icon: icons.home },
                { id: 'questionBank', label: 'الأسئلة', icon: icons.book },
                { id: 'explanations', label: 'شروحات', icon: icons.lightbulb },
                { id: 'community', label: 'المجتمع', icon: icons.users },
                { id: 'leaderboard', label: 'المتصدرون', icon: icons.trophy },
                { id: 'reviews', label: 'الآراء', icon: icons.reviews },
            ];
            
            navBarEl.innerHTML = navItems.map(item => `
                <button data-page="${item.id}" class="nav-item flex flex-col items-center justify-center p-2 rounded-full transition-all duration-300 w-1/6 ${currentPage === item.id ? 'active' : 'themed-text-secondary hover:text-indigo-600 dark:hover:text-indigo-400'}">
                    <span class="w-6 h-6">${item.icon}</span>
                    <span class="text-xs mt-1 font-semibold">${item.label}</span>
                </button>
            `).join('');
        }

        // =================================================================
        // HTML TEMPLATES
        // =================================================================

        function getHomePageHTML() {
            return `
                <div class="page active flex flex-col items-center justify-center h-full text-center py-10 animate-fade-in">
                    <div class="w-24 h-24 mb-6 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-white text-5xl font-bold">ن</span>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-extrabold themed-text-primary mb-4">مرحباً ${userData?.name || 'بك'} في نبراس النجاح!</h2>
                    <p class="text-lg md:text-xl themed-text-secondary max-w-2xl mb-10">رفيقك الذكي في رحلتك نحو التفوق الدراسي.</p>
                    <div class="w-full p-6 themed-card-bg rounded-2xl shadow-lg border themed-border mb-8">
                        <h3 class="text-2xl font-bold text-purple-600 dark:text-purple-400 mb-4 flex items-center justify-center"><span class="w-8 h-8 ml-2">${icons.brain}</span> اسأل Gemini</h3>
                         <textarea id="gemini-prompt-home" class="w-full p-4 border themed-border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg h-28 resize-none themed-card-bg themed-text-primary" placeholder="اسأل Gemini أي سؤال عن المنهج الدراسي العراقي..."></textarea>
                         <button id="ask-gemini-button-home" class="mt-4 w-full px-6 py-3 bg-gradient-to-br from-purple-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-300 transform hover:scale-105 flex items-center justify-center">
                            <span class="button-text">اسأل الآن واحصل على 5 نقاط</span>
                            <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-purple-300 rounded-full h-6 w-6"></span>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 w-full">
                        ${createFeatureCard({ title: "بنك الأسئلة", description: "تدرب على أسئلة وزارية", icon: icons.book, page: 'questionBank' })}
                        ${createFeatureCard({ title: "المجتمع الطلابي", description: "تواصل مع زملائك", icon: icons.users, page: 'community' })}
                        ${createFeatureCard({ title: "لوحة المتصدرين", description: "تنافس واجمع النقاط", icon: icons.trophy, page: 'leaderboard' })}
                        ${createFeatureCard({ title: "شروحات ذكية", description: "فهم سهل للمواضيع", icon: icons.lightbulb, page: 'explanations' })}
                        ${createFeatureCard({ title: "آراء المستخدمين", description: "شاركنا تجربتك", icon: icons.reviews, page: 'reviews' })}
                        ${createFeatureCard({ title: "ملفك الشخصي", description: "تابع تقدمك وإنجازاتك", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`, page: 'profile' })}
                    </div>
                </div>`;
        }
        
        function getQuestionBankPageHTML() {
             return `
                <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold themed-text-primary mb-2 border-b themed-border pb-4">بنك الأسئلة الذكي</h2>
                    <p class="themed-text-secondary mb-6">تدرب على أسئلة تم إنشاؤها بواسطة Gemini، أو قم بإنشاء أسئلة جديدة بنفسك!</p>
                    
                    <div class="themed-bg-secondary p-4 rounded-lg border themed-border mb-6">
                        <h3 class="text-xl font-bold text-indigo-700 dark:text-indigo-400 mb-3">أنشئ أسئلتك الخاصة</h3>
                        <div class="flex flex-col md:flex-row gap-4 mb-4 items-center">
                            <select id="gen-question-stage" class="w-full md:w-1/2 p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>سادس ابتدائي</option><option>ثالث متوسط</option><option>سادس اعدادي علمي</option><option>سادس اعدادي ادبي</option>
                            </select>
                            <select id="gen-question-subject" class="w-full md:w-1/2 p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>الرياضيات</option><option>اللغة العربية</option><option>الفيزياء</option><option>الكيمياء</option><option>العلوم</option><option>التاريخ</option><option>الجغرافيا</option><option>الإسلامية</option>
                            </select>
                        </div>
                        <button id="generate-questions-btn" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center">
                            <span class="button-text"><span class="text-yellow-300">${icons.gemini}</span> إنشاء 5 أسئلة جديدة</span>
                            <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-indigo-300 rounded-full h-6 w-6"></span>
                        </button>
                    </div>

                    <h3 class="text-2xl font-bold themed-text-primary mb-4">قائمة الأسئلة</h3>
                    <div id="question-list" class="space-y-4"></div>
                </div>`;
        }
        
        function getCommunityPageHTML() {
             const questionsHTML = communityQuestions.length === 0 ? 
                `<p class="text-center themed-text-secondary text-lg py-10 themed-bg-secondary rounded-lg border themed-border">لا توجد أسئلة في المجتمع حتى الآن. كن أول من يطرح سؤالاً!</p>` : 
                communityQuestions.map(createCommunityQuestionCard).join('');

            return `
                <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold themed-text-primary mb-6 border-b themed-border pb-4">المجتمع الطلابي</h2>
                    <div class="mb-8 p-4 bg-red-500/10 rounded-lg border border-red-500/20">
                        <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-3">اطرح سؤالاً جديداً</h3>
                        <input type="text" id="community-question-text" class="w-full p-3 border themed-border rounded-lg mb-3 themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="اكتب سؤالك هنا..."/>
                        <div class="flex flex-col md:flex-row gap-3 mb-3">
                            <select id="community-question-stage" class="w-full p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="" disabled selected>اختر المرحلة</option><option>سادس ابتدائي</option><option>ثالث متوسط</option><option>سادس اعدادي علمي</option><option>سادس اعدادي ادبي</option>
                            </select>
                            <input type="text" id="community-question-subject" class="w-full p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="المادة (مثال: الفيزياء)"/>
                        </div>
                        <button id="submit-community-question" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition">اطرح سؤالك واحصل على 10 نقاط</button>
                    </div>
                    <h3 class="text-2xl font-bold themed-text-primary mb-4">نقاشات المجتمع</h3>
                    <div id="community-questions-list" class="space-y-4">${questionsHTML}</div>
                </div>`;
        }

        function getLeaderboardPageHTML() {
            const usersHTML = leaderboardUsers.length === 0 ?
                `<tr><td colspan="4" class="text-center themed-text-secondary text-lg py-10 bg-yellow-500/10 rounded-lg">لا يوجد متصدرون حتى الآن.</td></tr>` :
                leaderboardUsers.map((user, index) => `
                    <tr class="transition-colors ${user.id === userId ? 'bg-amber-500/20' : 'hover:bg-gray-500/10'}">
                        <td class="py-4 px-4 text-lg text-center ${index < 3 ? 'text-2xl' : ''}">${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : index + 1}</td>
                        <td class="py-4 px-4 themed-text-primary font-semibold">${user.name}</td>
                        <td class="py-4 px-4 themed-text-secondary">${user.stage}</td>
                        <td class="py-4 px-4 text-amber-600 dark:text-amber-400 font-bold flex items-center justify-end"><span class="ml-1">${icons.star}</span>${user.points}</td>
                    </tr>`).join('');

            return `
                <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold text-amber-600 dark:text-amber-400 mb-6 border-b themed-border pb-4 flex items-center"><span class="w-8 h-8 ml-2">${icons.trophy}</span>لوحة المتصدرين</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b themed-border">
                                <tr>
                                    <th class="py-3 px-4 text-center text-sm font-semibold themed-text-secondary uppercase">الترتيب</th>
                                    <th class="py-3 px-4 text-right text-sm font-semibold themed-text-secondary uppercase">الاسم</th>
                                    <th class="py-3 px-4 text-right text-sm font-semibold themed-text-secondary uppercase">المرحلة</th>
                                    <th class="py-3 px-4 text-right text-sm font-semibold themed-text-secondary uppercase">النقاط</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y themed-border">${usersHTML}</tbody>
                        </table>
                    </div>
                </div>`;
        }

        function getExplanationsPageHTML() {
             return `
                <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold themed-text-primary mb-6 border-b themed-border pb-4 flex items-center"><span class="w-8 h-8 ml-3 text-orange-500">${icons.lightbulb}</span>شروحات ذكية من Gemini</h2>
                     <div class="themed-bg-secondary p-4 rounded-lg border themed-border mb-6">
                        <h3 class="text-xl font-bold text-orange-700 dark:text-orange-400 mb-3">اطلب شرحاً لأي موضوع</h3>
                        <input id="explanation-topic" class="w-full p-3 border themed-border rounded-lg mb-3 themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="مثال: شرح قانون نيوتن الثاني"/>
                        <div class="flex flex-col md:flex-row gap-3 mb-3">
                            <select id="explanation-stage" class="w-full p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-orange-500">
                               <option>سادس ابتدائي</option><option>ثالث متوسط</option><option>سادس اعدادي علمي</option><option>سادس اعدادي ادبي</option>
                            </select>
                            <select id="explanation-subject" class="w-full p-3 border themed-border rounded-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-orange-500">
                               <option>العلوم</option><option>اللغة العربية</option><option>الرياضيات</option><option>الكيمياء</option><option>الفيزياء</option><option>التاريخ</option><option>الجغرافيا</option>
                            </select>
                        </div>
                        <button id="get-explanation-btn" class="w-full px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition flex items-center justify-center">
                            <span class="button-text"><span class="text-yellow-300">${icons.gemini}</span> اشرح لي</span>
                            <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-orange-300 rounded-full h-6 w-6"></span>
                        </button>
                     </div>
                    <div id="explanation-content" class="prose prose-rtl max-w-none text-lg leading-relaxed space-y-4 themed-text-primary">
                        <p class="text-center themed-text-secondary py-8">اكتب موضوعًا واضغط على "اشرح لي" للحصول على شرح مبسط من Gemini.</p>
                    </div>
                </div>`;
        }
        
        function getProfilePageHTML() {
            if (!userData) return `<p>جاري تحميل بيانات الملف الشخصي...</p>`;

            return `
                 <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold themed-text-primary mb-6 border-b themed-border pb-4">ملفي الشخصي</h2>
                    <div class="space-y-4 text-lg">
                        <p><strong>الاسم:</strong> <span class="themed-text-secondary">${userData.name}</span></p>
                        <p><strong>البريد الإلكتروني:</strong> <span class="themed-text-secondary">${userData.email}</span></p>
                        <p><strong>نقاطك الإجمالية:</strong> <span class="font-bold text-indigo-600 dark:text-indigo-400">${userData.points} نقطة</span></p>
                        <p><strong>المرحلة الدراسية:</strong> <span class="themed-text-secondary">${userData.stage}</span></p>
                        
                        <button id="ai-study-plan-btn" class="mt-6 w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition flex items-center justify-center">
                            <span class="ml-2">${icons.gemini}</span>
                            <span class="button-text">إنشاء خطة دراسية أسبوعية بالذكاء الاصطناعي</span>
                            <span class="button-loader hidden animate-spin mr-3 border-4 border-white border-t-green-300 rounded-full h-6 w-6"></span>
                        </button>

                        <button id="logout-button" class="mt-4 w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition flex items-center justify-center">
                            <span class="w-6 h-6 ml-2">${icons.logOut}</span>
                            تسجيل الخروج
                        </button>
                    </div>
                </div>`;
        }
        
         function getReviewsPageHTML() {
            const reviewsHTML = reviews.length > 0
                ? reviews.map(createReviewCard).join('')
                : `<p class="text-center themed-text-secondary text-lg py-10 themed-bg-secondary rounded-lg border themed-border">لا توجد آراء حتى الآن. كن أول من يشاركنا رأيه!</p>`;

            return `
                <div class="themed-card-bg p-6 rounded-2xl shadow-xl border themed-border animate-fade-in">
                    <h2 class="text-3xl font-bold themed-text-primary mb-6 border-b themed-border pb-4 flex items-center"><span class="w-8 h-8 ml-3 text-pink-500">${icons.reviews}</span>آراء المستخدمين</h2>
                    <div class="mb-8 p-4 themed-bg-secondary rounded-lg border themed-border">
                        <h3 class="text-xl font-semibold themed-text-primary mb-3">أضف رأيك واحصل على 15 نقطة</h3>
                        <textarea id="review-text" class="w-full p-3 border themed-border rounded-lg mb-3 themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ما هو رأيك في التطبيق؟"></textarea>
                        <div class="flex items-center justify-between">
                             <div id="rating-stars" class="flex space-x-1 space-x-reverse">
                                ${[5, 4, 3, 2, 1].map(star => `<button data-value="${star}" class="star text-gray-400 hover:text-yellow-400 transition-colors text-3xl">${icons.star}</button>`).join('')}
                            </div>
                            <button id="submit-review-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-all">أرسل رأيك</button>
                        </div>
                    </div>
                    <div id="reviews-list" class="space-y-4">${reviewsHTML}</div>
                </div>`;
        }

        // =================================================================
        // HTML COMPONENT TEMPLATES
        // =================================================================

        function createFeatureCard({ title, description, icon, page }) {
            return `<div data-page="${page}" class="feature-card themed-card-bg p-6 rounded-2xl shadow-lg hover:shadow-indigo-500/10 dark:hover:shadow-indigo-400/10 hover:-translate-y-1 transition-all cursor-pointer flex flex-col items-center text-center border themed-border">
                    <div class="mb-4 text-indigo-500 dark:text-indigo-400 w-10 h-10 flex items-center justify-center">${icon}</div>
                    <h3 class="text-lg font-bold themed-text-primary mb-2">${title}</h3>
                    <p class="themed-text-secondary text-sm">${description}</p>
                </div>`;
        }

        function createQuestionCard({ question, answer, id }) {
             return `<div class="themed-bg-secondary p-4 rounded-lg shadow-sm border themed-border animate-fade-in">
                    <p class="font-semibold text-lg themed-text-primary mb-3">${question}</p>
                    <button data-question-id="${id}" class="toggle-answer-btn px-4 py-2 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600 transition flex items-center">
                        <span class="btn-icon w-4 h-4 ml-2">${icons.checkCircle}</span>
                        <span class="btn-text">عرض الإجابة</span>
                    </button>
                    <div id="answer-${id}" class="hidden mt-3 p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-lg text-indigo-800 dark:text-indigo-200">
                        <p class="font-medium">${answer}</p>
                    </div>
                </div>`;
        }
        
        function createCommunityQuestionCard(q) {
            const answersHTML = q.answers && q.answers.length > 0 ?
                `<ul class="space-y-3 mt-3">
                    ${q.answers.map(ans => `
                        <li class="border-t themed-border pt-3">
                           <p class="themed-text-primary">${ans.text}</p>
                           <div class="flex items-center justify-between mt-2 text-xs">
                             <span class="themed-text-secondary">بواسطة: ${ans.userName}</span>
                             <button class="explain-answer-btn text-purple-600 dark:text-purple-400 hover:underline font-semibold flex items-center" data-question="${q.questionText}" data-answer="${ans.text}"><span class="ml-1">${icons.gemini}</span>شرح هذه الإجابة</button>
                           </div>
                        </li>`).join('')}
                </ul>` :
                `<p class="themed-text-secondary text-sm mt-3">لا توجد إجابات بعد. كن أول من يجيب!</p>`;

            return `
                 <div key="${q.id}" class="themed-card-bg p-4 rounded-lg shadow border themed-border animate-fade-in">
                    <p class="font-semibold text-lg themed-text-primary mb-2">${q.questionText}</p>
                    <div class="flex items-center text-sm themed-text-secondary mb-3 flex-wrap gap-x-3 gap-y-1">
                        <span><strong class="font-medium themed-text-primary">المرحلة:</strong> ${q.stage}</span>
                        <span><strong class="font-medium themed-text-primary">المادة:</strong> ${q.subject}</span>
                        <span><strong class="font-medium themed-text-primary">بواسطة:</strong> ${q.userName}</span>
                        ${q.timestamp ? `<span class="text-gray-400">${new Date(q.timestamp.toDate()).toLocaleDateString('ar-IQ')}</span>` : ''}
                    </div>
                    <div class="mt-3 border-t themed-border pt-3">
                        <h4 class="font-medium themed-text-primary mb-2">الإجابات (${(q.answers || []).length}):</h4>
                        ${answersHTML}
                        <div class="mt-4 flex">
                            <input type="text" id="answer-input-${q.id}" class="flex-grow p-2 border themed-border rounded-l-lg themed-card-bg themed-text-primary focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="أضف إجابتك هنا..."/>
                            <button data-question-id="${q.id}" class="submit-answer-btn px-4 py-2 bg-red-500 text-white rounded-r-lg hover:bg-red-600 transition">إرسال</button>
                        </div>
                    </div>
                </div>`;
        }
        
        function createReviewCard(review) {
            const starsHTML = Array(5).fill(0).map((_, i) => 
                `<span class="w-5 h-5 ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}">${icons.star}</span>`
            ).join('');
            return `
                <div class="themed-bg-secondary p-4 rounded-lg shadow-sm border themed-border animate-fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold themed-text-primary">${review.userName}</h4>
                        <div class="flex">${starsHTML}</div>
                    </div>
                    <p class="themed-text-secondary">${review.text}</p>
                    <p class="text-xs text-gray-400 mt-2">${new Date(review.timestamp.toDate()).toLocaleString('ar-IQ')}</p>
                </div>
            `;
        }

        // =================================================================
        // EVENT LISTENERS & HANDLERS
        // =================================================================

        function addEventListeners() {
            navBarEl.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem && navItem.dataset.page !== currentPage) {
                     currentPage = navItem.dataset.page; 
                     render(); 
                }
            });

            mainContentEl.addEventListener('click', (e) => {
                const featureCard = e.target.closest('.feature-card');
                if (featureCard) { currentPage = featureCard.dataset.page; render(); }

                if (e.target.closest('.explain-answer-btn')) {
                    const button = e.target.closest('.explain-answer-btn');
                    const question = button.dataset.question;
                    const answer = button.dataset.answer;
                    handleExplainAnswer(question, answer);
                }
            });

            document.getElementById('profile-nav-button').addEventListener('click', () => {
                if (currentPage !== 'profile') { currentPage = 'profile'; render(); }
            });

            themeToggleButtonEl.addEventListener('click', toggleTheme);
            modalCloseBtn.addEventListener('click', () => modalEl.classList.add('hidden'));
            
            document.getElementById('show-register-btn').addEventListener('click', () => {
                loginCardEl.classList.add('hidden');
                registerCardEl.classList.remove('hidden');
            });
            document.getElementById('show-login-btn').addEventListener('click', () => {
                registerCardEl.classList.add('hidden');
                loginCardEl.classList.remove('hidden');
            });
            
            loginFormEl.addEventListener('submit', handleLogin);
            registerFormEl.addEventListener('submit', handleRegister);
        }

        function addHomeEventListeners() {
            document.getElementById('ask-gemini-button-home')?.addEventListener('click', askGeneralGemini);
        }

        function addQuestionBankEventListeners() {
            const questionList = document.getElementById('question-list');
            
            function renderQuestions() {
                if (questionBank.length > 0) {
                    questionList.innerHTML = questionBank.map(q => createQuestionCard({ ...q, id: Math.random() })).join('');
                } else {
                     questionList.innerHTML = `<div class="text-center p-10 themed-bg-secondary rounded-lg">
                        <p class="themed-text-secondary text-lg mb-4">لم يتم تحميل الأسئلة بعد.</p>
                        <p class="themed-text-secondary">اختر مرحلة ومادة ثم اضغط على زر "إنشاء أسئلة" أعلاه.</p>
                    </div>`;
                }
            }

            document.getElementById('generate-questions-btn').addEventListener('click', handleGenerateQuestions);
            
            questionList.addEventListener('click', (e) => {
                const button = e.target.closest('.toggle-answer-btn');
                if (button) {
                    const questionId = button.dataset.questionId;
                    const answerDiv = document.getElementById(`answer-${questionId}`);
                    const iconEl = button.querySelector('.btn-icon');
                    const textEl = button.querySelector('.btn-text');
                    const isHidden = answerDiv.classList.toggle('hidden');
                    textEl.textContent = isHidden ? 'عرض الإجابة' : 'إخفاء الإجابة';
                    if(!isHidden) {
                        updateUserPoints(2); 
                    }
                }
            });
            renderQuestions();
        }
        
        function addCommunityEventListeners() {
             document.getElementById('submit-community-question').addEventListener('click', handleAddCommunityQuestion);
             document.getElementById('community-questions-list').addEventListener('click', e => {
                const answerButton = e.target.closest('.submit-answer-btn');
                if (answerButton) {
                    handleAddAnswer(answerButton.dataset.questionId);
                }
            });
        }

        function addExplanationsEventListeners() {
            document.getElementById('get-explanation-btn').addEventListener('click', handleGetExplanation);
        }

        function addProfileEventListeners() {
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);
            document.getElementById('ai-study-plan-btn')?.addEventListener('click', handleGenerateStudyPlan);
        }
        
         function addReviewsEventListeners() {
            let currentRating = 0;
            const starsContainer = document.getElementById('rating-stars');
            const stars = starsContainer.querySelectorAll('.star');

            starsContainer.addEventListener('click', e => {
                const star = e.target.closest('.star');
                if (!star) return;
                currentRating = parseInt(star.dataset.value);
                stars.forEach(s => {
                    s.classList.toggle('text-yellow-400', parseInt(s.dataset.value) <= currentRating);
                    s.classList.toggle('text-gray-300', parseInt(s.dataset.value) > currentRating);
                });
            });

            document.getElementById('submit-review-btn').addEventListener('click', () => {
                const text = document.getElementById('review-text').value;
                if (!text.trim() || currentRating === 0) {
                    showModal("الرجاء كتابة رأيك واختيار تقييم (عدد النجوم).");
                    return;
                }
                handleAddReview(text, currentRating);
            });
        }
        
        // =================================================================
        // THEME FUNCTIONS
        // =================================================================

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
            updateThemeToggleButton();
        }

        function updateThemeToggleButton() {
            if (currentTheme === 'dark') {
                themeToggleButtonEl.innerHTML = icons.sun;
            } else {
                themeToggleButtonEl.innerHTML = icons.moon;
            }
        }

        function toggleTheme() {
            currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', currentTheme);
            updateThemeToggleButton();
        }

        // =================================================================
        // FIREBASE & LOGIC FUNCTIONS
        // =================================================================

        async function initialize() {
            // DOM element caching
            mainAppEl = document.getElementById('main-app');
            authScreenEl = document.getElementById('auth-screen');
            mainContentEl = document.getElementById('main-content');
            navBarEl = document.getElementById('nav-bar');
            themeToggleButtonEl = document.getElementById('theme-toggle-button');
            modalEl = document.getElementById('custom-modal');
            modalContentEl = document.getElementById('modal-content');
            modalLoaderEl = document.getElementById('modal-loader');
            modalCloseBtn = document.getElementById('modal-close-button');
            loginFormEl = document.getElementById('login-form');
            registerFormEl = document.getElementById('register-form');
            loginCardEl = document.getElementById('login-card');
            registerCardEl = document.getElementById('register-card');

            applyInitialTheme();

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await generateInitialQuestionBank();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isLoggedIn = true;
                        
                        const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                        let userDocSnap = await getDoc(userDocRef);

                        if (!userDocSnap.exists()) {
                            await handleNewUserSetup(user);
                            userDocSnap = await getDoc(userDocRef);
                        }
                        userData = userDocSnap.data();
                        
                        await syncLeaderboard(userData);
                        setupFirestoreListeners();

                    } else {
                        userId = null; userData = null; isLoggedIn = false;
                        currentPage = 'home';
                    }
                    isAuthReady = true;
                    render();
                });
            } catch (e) {
                handleError(e, "فشل تهيئة التطبيق");
                isAuthReady = true;
                render();
            }
            addEventListeners();
        }

        async function handleNewUserSetup(user, extraData = {}) {
             const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
             const initialData = {
                name: user.displayName || extraData.username || `طالب ${user.uid.substring(0, 5)}`,
                email: user.email,
                points: 0,
                stage: extraData.stage || 'غير محدد',
                createdAt: serverTimestamp(),
            };
            await setDoc(userDocRef, initialData);
            return initialData;
        }

        async function syncLeaderboard(currentUserData) {
            if (!db || !userId) return;
            const leaderboardDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard/${userId}`);
            try {
               await setDoc(leaderboardDocRef, {
                   name: currentUserData.name,
                   stage: currentUserData.stage,
                   points: currentUserData.points,
               }, { merge: true });
           } catch(e) {
               handleError(e, "فشل تحديث لوحة المتصدرين");
           }
        }
        
        function setupFirestoreListeners() {
            if (!db || !isLoggedIn) return;

            const qQuery = query(collection(db, `artifacts/${appId}/public/data/community_questions`));
            onSnapshot(qQuery, (snap) => {
                communityQuestions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                if (currentPage === 'community') renderPage();
            }, (err) => handleError(err, "خطأ في جلب أسئلة المجتمع"));
            
            const lQuery = query(collection(db, `artifacts/${appId}/public/data/leaderboard`));
            onSnapshot(lQuery, (snap) => {
                leaderboardUsers = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.points || 0) - (a.points || 0));
                 if (currentPage === 'leaderboard') renderPage();
            }, (err) => handleError(err, "خطأ في جلب بيانات المتصدرين"));

            const rQuery = query(collection(db, `artifacts/${appId}/public/data/reviews`));
             onSnapshot(rQuery, (snap) => {
                reviews = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                if (currentPage === 'reviews') renderPage();
            }, (err) => handleError(err, "خطأ في جلب آراء المستخدمين"));
        }

        function handleError(error, customMessage = "حدث خطأ ما") {
            console.error(customMessage, error);
            showModal(`${customMessage}: ${error.message || 'يرجى المحاولة مرة أخرى.'}`);
        }
        
        function showModal(content, showLoader = false) {
            modalContentEl.innerHTML = content;
            modalLoaderEl.classList.toggle('hidden', !showLoader);
            modalCloseBtn.classList.toggle('hidden', showLoader);
            modalEl.classList.remove('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg flex items-center';
            toast.innerHTML = `<span class="w-6 h-6 ml-2">${icons.gemini}</span><span>${message}</span>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000); 
        }
        
        async function updateUserPoints(pointsToAdd) {
            if (!db || !userId) return;
            try {
                const newPoints = (userData?.points || 0) + pointsToAdd;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                await updateDoc(userDocRef, { points: newPoints });
                userData.points = newPoints;
                await syncLeaderboard(userData);
                showToast(`+${pointsToAdd} نقطة!`);
                render();
            } catch (e) {
                handleError(e, "خطأ في تحديث النقاط");
            }
        }
        
        // =================================================================
        // GEMINI API FUNCTIONS
        // =================================================================

        async function callGemini(prompt) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
             const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             if (!response.ok) {
                 const errorBody = await response.text();
                 console.error("Gemini API Error:", errorBody);
                 throw new Error(`فشل طلب الـ API بالحالة ${response.status}`);
             }
             const result = await response.json();
             if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                 return result.candidates[0].content.parts[0].text;
             }
             console.error("Unexpected Gemini response:", result);
             throw new Error("لم يتم العثور على محتوى في استجابة Gemini.");
        }
        
        async function generateInitialQuestionBank() {
            try {
                const prompt = `أنشئ لي مجموعة من 10 أسئلة متنوعة ومتوافقة مع المناهج العراقية للمراحل الدراسية: "سادس ابتدائي", "ثالث متوسط", "سادس اعدادي علمي", "سادس اعدادي ادبي". يجب أن تغطي الأسئلة مواد مختلفة مثل الرياضيات, الفيزياء, الكيمياء, اللغة العربية. قدم الإجابة **فقط** على شكل مصفوفة JSON صالحة (array of objects), حيث كل كائن يحتوي على: "question", "answer", "stage", "subject". لا تضف أي نص قبل أو بعد الـ JSON.`;
                const responseText = await callGemini(prompt);
                const jsonStringMatch = responseText.match(/\[[\s\S]*\]/);
                if (jsonStringMatch) {
                    questionBank = JSON.parse(jsonStringMatch[0]);
                } else {
                    console.error("Could not parse bank from AI:", responseText);
                    questionBank = [];
                }
            } catch (e) {
                console.error("Failed to generate question bank:", e);
                questionBank = [];
            }
        }

        async function askGeneralGemini() {
            const prompt = document.getElementById('gemini-prompt-home').value;
            if (!prompt.trim()) return showModal("الرجاء كتابة سؤال أولاً.");
            const button = document.getElementById('ask-gemini-button-home');
            setButtonLoading(button, true);
            try {
                const fullPrompt = `أجب على السؤال التالي بوضوح وبساطة كمدرس عراقي اسمه "نبراس"، مع تنسيق الإجابة بـ Markdown: ${prompt}`;
                const text = await callGemini(fullPrompt);
                showModal(`<div class="prose prose-rtl max-w-none text-right">${text}</div>`);
                await updateUserPoints(5);
            } catch (error) {
                handleError(error, "خطأ في الاتصال بالذكاء الاصطناعي");
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function handleGenerateQuestions() {
            const stage = document.getElementById('gen-question-stage').value;
            const subject = document.getElementById('gen-question-subject').value;
            const button = document.getElementById('generate-questions-btn');
            setButtonLoading(button, true);
            try {
                const prompt = `أنشئ لي 5 أسئلة مع إجاباتها لمادة "${subject}" للمرحلة "${stage}" حسب المنهج العراقي. قدم الإجابة **فقط** كـ JSON array of objects. كل كائن يجب أن يحتوي على "question" و "answer".`;
                const responseText = await callGemini(prompt);
                const jsonStringMatch = responseText.match(/\[[\s\S]*\]/);
                if (jsonStringMatch) {
                    questionBank = JSON.parse(jsonStringMatch[0]);
                    renderPage();
                    showToast("تم إنشاء أسئلة جديدة بنجاح!");
                } else {
                    throw new Error("لم يرجع الذكاء الاصطناعي تنسيقًا صحيحًا.");
                }
            } catch (e) {
                handleError(e, "فشل إنشاء الأسئلة");
            } finally {
                setButtonLoading(button, false);
            }
        }
        
         async function handleAddCommunityQuestion() {
            const text = document.getElementById('community-question-text').value;
            const stage = document.getElementById('community-question-stage').value;
            const subject = document.getElementById('community-question-subject').value;

            if (!text.trim() || !stage || !subject.trim()) return showModal("الرجاء ملء جميع حقول السؤال.");
            if (!db || !userId) return showModal("يرجى تسجيل الدخول أولاً.");
            
            showModal("✨ جارٍ طرح سؤالك...", true);
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/community_questions`), {
                    questionText: text, stage, subject, userId,
                    userName: userData?.name || 'مجهول',
                    timestamp: serverTimestamp(),
                    answers: [],
                });
                modalEl.classList.add('hidden');
                showToast("تم طرح سؤالك بنجاح!");
                await updateUserPoints(10);
            } catch (e) {
                handleError(e, "خطأ في إضافة سؤال للمجتمع");
            }
        }
        
        async function handleAddAnswer(questionId) {
             const answerTextEl = document.getElementById(`answer-input-${questionId}`);
             if (!answerTextEl.value.trim()) return showModal("الرجاء كتابة الإجابة أولاً.");
             if (!db || !userId) return showModal("يرجى تسجيل الدخول أولاً.");
             
             showModal("✨ جارٍ إضافة إجابتك...", true);
             try {
                const qDocRef = doc(db, `artifacts/${appId}/public/data/community_questions`, questionId);
                const question = communityQuestions.find(q => q.id === questionId);
                const currentAnswers = question.answers || [];
                await updateDoc(qDocRef, {
                    answers: [...currentAnswers, { text: answerTextEl.value, userId, userName: userData?.name || 'مجهول', timestamp: new Date() }],
                });
                modalEl.classList.add('hidden');
                showToast("تمت إضافة إجابتك بنجاح!");
                await updateUserPoints(7);
             } catch(e) {
                 handleError(e, "خطأ في إضافة الإجابة");
             }
        }
        
         async function handleAddReview(text, rating) {
            if (!db || !userId) return showModal("يرجى تسجيل الدخول أولاً.");
            showModal("✨ جارٍ إرسال رأيك...", true);
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/reviews`), {
                    text, rating, userId,
                    userName: userData.name,
                    timestamp: serverTimestamp()
                });
                modalEl.classList.add('hidden');
                showToast("شكراً لمشاركتنا رأيك!");
                await updateUserPoints(15);
            } catch (e) {
                handleError(e, "فشل إرسال الرأي");
            }
        }

        async function handleGetExplanation() {
            const topic = document.getElementById('explanation-topic').value;
            const stage = document.getElementById('explanation-stage').value;
            const subject = document.getElementById('explanation-subject').value;
            const contentDiv = document.getElementById('explanation-content');
            const button = document.getElementById('get-explanation-btn');

            if (!topic.trim()) return showModal("الرجاء كتابة الموضوع.");
            setButtonLoading(button, true);
            contentDiv.innerHTML = `<div class="flex justify-center p-8"><div class="animate-spin border-8 border-gray-300 border-t-orange-500 rounded-full h-16 w-16"></div></div>`;
            try {
                const prompt = `اشرح لي موضوع "${topic}" في مادة "${subject}" للمرحلة "${stage}" بالعراق. قدم شرحاً مبسطاً وواضحاً مع أمثلة. استخدم تنسيق Markdown.`;
                const explanation = await callGemini(prompt);
                contentDiv.innerHTML = `<div class="prose prose-rtl max-w-none text-right">${explanation}</div>`;
                await updateUserPoints(5);
            } catch(e) {
                handleError(e, "فشل في جلب الشرح");
                contentDiv.innerHTML = `<p class="text-center text-red-500">حدث خطأ.</p>`;
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function handleGenerateStudyPlan() {
            const button = document.getElementById('ai-study-plan-btn');
            setButtonLoading(button, true);
            showModal("✨ يعمل الذكاء الاصطناعي على إعداد خطتك...", true);
            try {
                const prompt = `أنا طالب بمرحلة "${userData.stage}" في العراق. أنشئ لي خطة دراسية لـ 7 أيام. ركز على المواد الأساسية. اجعلها واقعية مع أوقات للمذاكرة والاستراحة. قدمها كجدول Markdown.`;
                const plan = await callGemini(prompt);
                showModal(`<div class="prose prose-rtl max-w-none text-right"><h2>خطة الدراسة الأسبوعية المقترحة</h2>${plan}</div>`);
                await updateUserPoints(20);
            } catch (e) {
                handleError(e, "فشل إنشاء الخطة الدراسية");
            } finally {
                 setButtonLoading(button, false);
            }
        }

        async function handleExplainAnswer(question, answer) {
            showModal("✨ يقوم Gemini بتحليل وشرح الإجابة...", true);
            try {
                const prompt = `السؤال هو: "${question}". إجابة طالب: "${answer}". كمدرس عراقي، قيّم هذه الإجابة، ووضح صحتها، ثم قدم شرحًا مبسطًا ومفصلاً للإجابة الكاملة.`;
                const explanation = await callGemini(prompt);
                showModal(`<div class="prose prose-rtl max-w-none text-right"><h3>السؤال:</h3><p>${question}</p><h3>الإجابة المقترحة:</h3><p>${answer}</p><hr><h3>شرح Gemini:</h3>${explanation}</div>`);
            } catch(e) {
                handleError(e, "فشل في شرح الإجابة");
            }
        }

        // =================================================================
        // AUTHENTICATION & UTILITY FUNCTIONS
        // =================================================================
        
        async function handleLogout() {
            try {
                await signOut(auth);
                showToast("تم تسجيل الخروج بنجاح.");
            } catch (e) {
                handleError(e, "فشل تسجيل الخروج");
            }
        }
        
        function setButtonLoading(buttonEl, isLoading) {
            if (!buttonEl) return;
            const textSpan = buttonEl.querySelector('.button-text');
            const loaderSpan = buttonEl.querySelector('.button-loader');
            buttonEl.disabled = isLoading;
            if (isLoading) {
                if (textSpan) textSpan.classList.add('invisible');
                if (loaderSpan) loaderSpan.classList.remove('hidden');
            } else {
                if (textSpan) textSpan.classList.remove('invisible');
                if (loaderSpan) loaderSpan.classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const button = document.getElementById('login-button');
            if (!email || !password) return showModal("الرجاء إدخال البيانات.");
            setButtonLoading(button, true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("تم تسجيل الدخول بنجاح!");
            } catch (error) {
                handleError(error, "فشل تسجيل الدخول");
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const stage = document.getElementById('register-stage').value;
            const button = document.getElementById('register-button');

            if (!email || !password || !username || !stage) return showModal("الرجاء ملء جميع الحقول.");
            setButtonLoading(button, true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: username });
                const newUserData = await handleNewUserSetup(userCredential.user, { username, stage });
                await syncLeaderboard(newUserData);
                showToast("تم إنشاء الحساب بنجاح! مرحباً بك.");
            } catch (error) {
                let msg = "خطأ في إنشاء الحساب.";
                if (error.code === 'auth/email-already-in-use') msg = "البريد الإلكتروني مستخدم بالفعل.";
                else if (error.code === 'auth/weak-password') msg = "كلمة المرور ضعيفة جداً (6 أحرف على الأقل).";
                handleError(error, msg);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // =================================================================
        // INITIALIZATION CALL
        // =================================================================
        window.onload = initialize;

    </script>
</body>
</html>

